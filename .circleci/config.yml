version: 2.1
orbs:
  pulumi: pulumi/pulumi@2.0.0
  ghpr: narrativescience/ghpr@1.1.1
  browser-tools: circleci/browser-tools@1.1.3

jobs:
  build:
    docker:
      - image: 'circleci/node:14.16-browsers'
    working_directory: ~/repo/
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
      - pulumi/login
      - pulumi/stack_init:
          stack: 'proxor-theia/test-pr_${CIRCLE_BUILD_NUM}'
      - run:
            name: Install dependency and set pulumi region
            command: |
              npm install
              pulumi config set aws:region ap-south-1
      - pulumi/update:
          stack: 'proxor-theia/test-pr_${CIRCLE_BUILD_NUM}'
      - pulumi/stack_output:
          stack: 'proxor-theia/test-pr_${CIRCLE_BUILD_NUM}'
          property_name: demoUrl
          env_var: TEST_URL
      - ghpr/post-pr-comment:
          comment: ${TEST_URL}
          when: always
      - run:
          name: Install Chrome latest version
          command: |
            sudo apt-get install lsb-release libappindicator3-1
            curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            sudo dpkg -i google-chrome.deb
            sudo sed -i 's|HERE/chrome"|HERE/chrome" --no-sandbox|g' /opt/google/chrome/google-chrome
            rm google-chrome.deb
      - run: cd selenium-tests && npm install
      - run: sleep 2m
      # run tests
      - run: cd selenium-tests && npm run theiaCommon -- --baseUrl ${TEST_URL}
      - store_test_results:
          path: ~/repo/selenium-tests/test_results
